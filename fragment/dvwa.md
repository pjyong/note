# DVWA和网站漏洞

DVWA是一个用来进行安全脆弱性鉴定的PHP/MySQL Web应用。它包含了一些网站漏洞：
* 暴力算法破解。用户登录暴力算法破解密码
* 跨站脚本攻击(XSS)。
* 命令行注入。在操作系统里执行命令行
* 伪造跨站请求(CSRF)。就是做一个伪造页，让用户无法识别真假输入密码。
* 文件引入。
* SQL注入。
* 不安全文件上传。
* 复活节彩蛋。

DVWA的代码分为四种安全级别：Low,Medium,High,Impossible。最好在本地环境安装DVWA应用自己玩玩。对应各个漏洞，我站在开发者的角度说说各个安全级别的情况。

## 暴力算法破解

* Low
  * 开发者没有任何防御措施，导致攻击者可以反复发送他们的请求验证数据是否正确
* Medium
  * 开发者给每个失败请求sleep(2)，增加攻击者每次请求所耗时间
* High
  * 开发者使用Token来防止CSRF漏洞，这样攻击者就只能到用户的页面操作。当然了还是得保留失败请求的等待时间，最好是个随机数来迷惑攻击者
* Impossible
  * 在High的基础上，加一个登录限制，超过5次登录失败，账户被锁定15分钟。直接在用户表里面添加login_failed次数和恢复时间

## 跨站脚本攻击

跨站脚本，简称XSS，是一种迫使Web站点回显可执行代码的攻击技术。攻击目标是盗取客户端的cookie或者其它网站用于识别客户端身份的敏感信息，假冒最终用户和网站交互。

XSS漏洞成因是没有对用户提交的数据做充分检查，允许用户在提交的数据中惨入HTML代码(最主要的是“>”、“<”)，然后未加编码地输出到第三方用户的浏览器。

XSS漏洞也分为反射型和存储型。也可以理解成GET传值，和POST传值。

下面是反射型对应的安全级别:
* Low
  * 开发者没有过滤任何参数，直接将参数输出到页面
* Medium
  * 开发者做了些措施，比如替换了<script>，但是像这种情况没考虑到:<sCrIpt>、<s<script>crpt>
* High
  * 开发者屏蔽掉了所有脚本代码，比如使用这样的过滤正则表达式`/<s(.*)c(.*)r(.*)i(.*)p(.*)t/i`
* Impossible
  * 将所有输出数据都用htmlspecialchars做处理

下面是存储型对应的安全级别:
* Low
  * 使用了trim()、mysql_real_escape_string()、stripslashes()等来对输入内容进行处理
* Medium
  * 基于Low，对输入内容做了script的过滤
* High
  * 基于Low，使用正则表达式`/<s(.*)c(.*)r(.*)i(.*)p(.*)t/i`进行了过滤，但是并没有对img等标签做处理
* Impossible
  * 基于Low，将所有输入全部htmlspecialchars然后存库

一句话，对于页面数据的交互，如果不想出问题，就都要htmlspecialchars。

## 伪造跨站请求

实际上就是伪造一个一模一样的网页，或者直接用接口去请求数据，这用token可避免。

## 命令行注入

安全级别从低到高，依次是过滤的非法字符越来越多。最后Impossible实际就是一个格式的检查，比如表单里需要输入一个IP，后台脚本在shell里ping这个IP。我不需要过滤很多非法字符，而是直接检查这个值是不是IP的格式。

## 文件引入

这个情况发生在一些很古老的代码里，比如url里面有个参数`?module=order`，后台程序`include(order.php)`。这样我就可以使用`?module=/etc/passwd`，或者一些远程脚本`?module=www.somesite.com/nightmare.php`

## SQL注入

这个也是发生在古老的代码里，没有使用prepare的参数化查询，而是没有使用mysqli_real_escape_string过滤参数就使用SQL拼接

## 不安全文件上传
* Low
  * 对上传文件不做任何检查
* Medium
  * 对文件类型做检查
* High
  * 对文件进行处理，如果是图片，就resize再保存
* Impossible
  * 上面的检查都做，并且对图片re-encode生成新图片，过滤一些非图片的代码。(从原图片imagecreatefromjpeg一张新图片)
